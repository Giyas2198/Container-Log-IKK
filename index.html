<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Container Loading Planner (ROLL Dinamis)</title>

  <!-- Fonts & Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="styles.css"/>

  <!-- 3D & Excel Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Container Loading Planner (Dinamis)</h1>
  </header>

  <div id="main-content">
    <section id="input-section">
      <h3>üõí Input Daftar Roll Pemuatan:</h3>

      <div id="material-header" class="material-item header-row">
        <div style="flex-grow: 1.5;">Material ID</div>
        <div style="flex-grow: 2.5;">Deskripsi</div>
        <div style="flex-grow: 0.5; text-align: center;">Jml (Qty)</div>
        <div style="flex: 0 0 100px; text-align: center;">D x L (m)</div>
        <div style="flex: 0 0 100px; text-align: center;">Berat (kg/ton)</div>
        <div style="width: 28px;"></div>
      </div>

      <div id="material-list"></div>

      <div class="button-group">
        <button id="add-material-btn">‚ûï Tambah Roll Baru</button>
        <button id="visualize-btn">‚ú® Visualisasi Pemuatan 3D</button>
        <button id="move-btn" style="display:none;">üñ±Ô∏è Pindah Roll</button>
        <button id="save-btn" style="display:none;">‚úÖ Selesai Pindah (Kunci)</button>
        <button id="crane-btn">üèóÔ∏è Pakai Crane</button>
      </div>

      <hr style="margin-top: 25px; margin-bottom: 25px;" />

      <div id="transport-section">
        <h3>üöö Pilih Moda Transportasi</h3>
        <label for="moda-selector" style="font-weight: 600; margin-bottom: 5px; display: block;">Jenis Moda:</label>
        <select id="moda-selector">
          <option value="40hc">Container 40ft HC (P:12.032m, L:2.352m, T:2.700m)</option>
          <option value="20ft">Container 20ft (P:5.898m, L:2.352m, T:2.700m)</option>
          <option value="tronton_lossbak">Tronton Lossbak (P:9.4m, L:2.4m, T:-)</option>
          <option value="wingbox">Wingbox (P:12.0m, L:2.4m, T:2.4m)</option>
        </select>
        <p class="note">Pilih moda, lalu klik 'Visualisasi Pemuatan 3D' untuk memperbarui kerangka.</p>
      </div>

      <div id="import-section">
        <h4>‚¨ÜÔ∏è Impor Database Material (Copy-Paste Tabel Excel)</h4>
        <p class="note">Tempelkan data (Material ID dan Deskripsi) di bawah. Kolom yang diharapkan:</p>
        <blockquote style="font-style: italic;">Kolom 1: Material ID, Kolom 2: Deskripsi</blockquote>
        <textarea id="excel-paste-area" placeholder="Tempelkan data Excel (Ctrl+V) di sini..." rows="6"></textarea>
        <button id="import-btn">üíæ Upload ke Database Firestore</button>
      </div>

      <p id="status-message" class="status-box"></p>
    </section>

    <section id="visualization-section">
      <h3>Visualisasi Kontainer</h3>
      <div id="container-info">
        Tipe Moda: <span id="current-moda-display">40ft HC</span> (P: 12.032m | L: 2.352m | T: 2.700m)
      </div>
      <div id="visualization-container" style="width: 100%; height: 420px; background: #0f172a; border-radius: 10px; overflow: hidden;"></div>
    </section>
  </div>

  <!-- App Logic for 3D (placeholder minimal) -->
  <script>
    (function initViewer() {
      const container = document.getElementById('visualization-container');
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0f172a);

      const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(6, 5, 8);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Grid & Light
      const grid = new THREE.GridHelper(12, 24, 0x2dd4bf, 0x334155);
      scene.add(grid);
      const light = new THREE.HemisphereLight(0xffffff, 0x222222, 1.0);
      scene.add(light);

      // Simple container box (approximate 40HC inner size)
      const geom = new THREE.BoxGeometry(12.032, 2.352, 2.700);
      const mat = new THREE.MeshBasicMaterial({ color: 0x22d3ee, wireframe: true });
      const box = new THREE.Mesh(geom, mat);
      box.position.set(12.032/2 - 0.1, 2.352/2, 0);
      scene.add(box);

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Resize
      window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });

      // Mode change updates info only (you bisa lanjutkan untuk update geometry)
      document.getElementById('moda-selector').addEventListener('change', (e) => {
        const span = document.getElementById('current-moda-display');
        const val = e.target.value;
        const text = {
          '40hc': '40ft HC',
          '20ft': '20ft',
          'tronton_lossbak': 'Tronton Lossbak',
          'wingbox': 'Wingbox'
        }[val] || '40ft HC';
        span.textContent = text;
      });
    })();
  </script>

  <!-- Firebase Modular SDK & wiring -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // TODO: Ganti dengan konfigurasi proyek kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("Firebase initialized");

    const statusEl = document.getElementById('status-message');
    const importBtn = document.getElementById('import-btn');
    const excelArea = document.getElementById('excel-paste-area');

    // Helper status
    function setStatus(type, msg) {
      statusEl.textContent = msg;
      statusEl.style.color = type === 'error' ? '#ef4444' : '#22c55e';
    }

    // Upload paste Excel (dua kolom: MaterialID, Deskripsi) ke koleksi "materials"
    importBtn.addEventListener('click', async () => {
      const raw = (excelArea.value || '').trim();
      if (!raw) { setStatus('error', 'Data kosong. Tempelkan tabel Excel terlebih dahulu.'); return; }

      // Parsing sederhana: pisah baris, lalu pisah kolom dengan tab atau koma
      const rows = raw.split(/\r?\n/).filter(r => r.trim().length > 0);
      const batch = [];
      for (const line of rows) {
        const cols = line.split(/\t|,/);
        const materialId = (cols[0] || '').trim();
        const desc = (cols[1] || '').trim();
        if (!materialId) continue;
        batch.push({ id: materialId, description: desc });
      }
      if (batch.length === 0) { setStatus('error', 'Tidak ada baris valid terdeteksi. Pastikan kolom 1: Material ID, kolom 2: Deskripsi.'); return; }

      try {
        // Tulis per dokumen menggunakan setDoc
        const start = performance.now();
        for (const item of batch) {
          await setDoc(doc(db, 'materials', item.id), {
            description: item.description,
            updatedAt: new Date().toISOString()
          }, { merge: true });
        }
        const ms = Math.round(performance.now() - start);
        setStatus('ok', `Upload ${batch.length} baris sukses (${ms} ms).`);
      } catch (err) {
        console.error(err);
        // Deteksi error offline dari Firestore
        const msg = (err && err.message) ? err.message : String(err);
        setStatus('error', `Gagal upload: ${msg}`);
      }
    });

    // Contoh read: ambil satu dokumen (untuk sanity check)
    async function fetchMaterialDetails(materialId) {
      try {
        const snap = await getDoc(doc(db, 'materials', materialId));
        if (snap.exists()) {
          console.log('Material Data:', snap.data());
          setStatus('ok', `Material ${materialId} ditemukan.`);
        } else {
          setStatus('error', `Material ${materialId} tidak ditemukan.`);
        }
      } catch (error) {
        console.error(error);
        setStatus('error', `Gagal mengambil data: ${error.message || error}`);
      }
    }

    // Tes panggilan awal (opsional)
    // fetchMaterialDetails("53025076");
  </script>
</body>
</html>
